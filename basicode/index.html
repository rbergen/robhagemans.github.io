<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="demo.css">
    <script src="basicode.js"></script>

    <script>

        // settings

        function loadSettings() {
            settings = document.getElementById('basicode-script').dataset;
            settings['columns'] = document.getElementById('columns').value;
            settings['rows'] = document.getElementById('rows').value;
            settings['speed'] = document.getElementById('speed').value;
            settings['font'] = document.getElementById('font').value;
            for (var i=0; i <=7; ++i) {
                settings['color-' + i] = document.getElementById('color-' + i).value;
            }
            document.getElementById('showspeed').value = document.getElementById('speed').value;
            restart();
            display = new Display(
                document.getElementById('showfont'), 16, 6,
                document.getElementById('font').value, apps['basicode-script'].display.colours);
            for (var i=32; i < 128; ++i) {
                display.write(String.fromCharCode(i));
            }
            display.write('.');
        }

        presets = {
            'cga': { 'columns': 40, 'rows': 25, 'font': 'cga',
                     'color-0': '#000000', 'color-7': '#ffffff',
                },
            'bbc': { 'columns': 40, 'rows': 32, 'font': 'bbc',
                     'color-0': '#000000', 'color-7': '#ffffff',
                },
            'c64': { 'columns': 40, 'rows': 25, 'font': 'c64',
                     'color-0': '#40318d', 'color-7': '#7869c4',
                },
            'spectrum': { 'columns': 32, 'rows': 24, 'font': 'spectrum',
                     'color-0': '#aaaaaa', 'color-7': '#000000',
                },
            'msx': { 'columns': 40, 'rows': 25, 'font': 'msx',
                     'color-0': '#5955e0', 'color-7': '#ffffff',
                },
            'cpc': { 'columns': 40, 'rows': 25, 'font': 'cpc',
                     'color-0': '#0000ff', 'color-7': '#ffff00',
                },
            'pcw': { 'columns': 90, 'rows': 32, 'font': 'pcw',
                     'color-0': '#000000', 'color-7': '#ffffff',
                },
            'coco': { 'columns': 32, 'rows': 16, 'font': 'coco',
                     'color-0': '#1bcb01', 'color-7': '#000000',
                },

        }

        function setSettings(preset) {
            var keys = Object.keys(presets[preset]);
            for (var k in keys) {
                document.getElementById(keys[k]).value = presets[preset][keys[k]];
            }
            loadSettings();
        }

        // listing

        function setupListing() {
            var listing = document.getElementById('listing0');
            var last_code = listing.value;

            // reload code if listing changes
            listing.onblur = function() {
                if (listing.value === last_code) return;
                last_code = listing.value;
                apps['basicode-script'].load(last_code);
            }
        }

        function onProgramLoad(program) {
            var listing = document.getElementById('listing0');
            var info = document.getElementById('info0');
            if (program === null) {
                listing.value = "";
                info.innerHTML = "";
            }
            else {
                listing.value = program.code;
                info.innerHTML = "<h2>" + program.title + "</h2>\n\n" +program.description;
            }
        }

        // storage

        // this is where we keep our blobs
        var blobbery = {};
        var mime_type = "text/plain";

        this.onFileStore = function(floppy)
        {
            var element = document.getElementById("flop1");
            var prefix = "BASICODE";

            if (!element) return;
            while (element.firstChild) {
                element.removeChild(element.firstChild);
            }
            for (var i=0; i < localStorage.length; ++i) {
                var key = localStorage.key(i)
                var key_list = key.split(":");
                if (key_list[0] !== prefix) continue;
                if (key_list[1] !== "" + floppy.id) continue;
                // create content blob from local storage, if necessary
                if (!(key in blobbery)) {
                    blobbery[key] = new Blob([localStorage.getItem(key)], {type: mime_type});
                }
                // create download link to file
                var a = document.createElement("a");
                a.textContent = key_list[2];
                a.href = window.URL.createObjectURL(blobbery[key]);
                a.download = key_list[2];
                // drag-out support
                a.dataset.downloadurl = [mime_type, a.download, a.href].join(":");
                a.draggable = true;
                a.addEventListener("dragstart", function(e) {
                    e.dataTransfer.setData("DownloadURL", a.dataset.downloadurl);
                }, false);
                element.appendChild(a);
            }
        }

        function setup() {
            loadSettings();
            setupListing();
        }
    </script>
</head>

<body onload="setup();">

    <script type="text/basicode"
        data-printer="printer0"
        data-canvas="canvas0"
        data-input="screen"
        data-load="onProgramLoad"
        data-store="onFileStore"
        id="basicode-script"
        ></script>

    <div class="tabs">

        <div id="settings">
            <a class="tab" href="#settings">Settings</a>
            <div style="font-family: sans">
                <form onchange="loadSettings();">
                    <fieldset>
                        <legend>Colours</legend>
                        <table style="width:100%">
                            <tr>
                                <td></td>
                                <th colspan="3">Background / 0</th>
                                <th colspan="3">Foreground / 7</th>
                            </tr>
                            <tr>
                                <th align="right">Basicode 2 &amp; 3</th>
                                <td colspan="3"><input type="color" id="color-0" value="#000000" style="width: 100%" onchange="loadSettings();"></td>
                                <td colspan="3"><input type="color" id="color-7" value="#ffffff" style="width: 100%" onchange="loadSettings();"></td>
                            </tr>
                            <tr>
                                <th align="right">Basicode 3C</th>
                                <td><input type="color" id="color-1" value="#0000aa" style="width: 100%" onchange="loadSettings();"></td>
                                <td><input type="color" id="color-2" value="#aa0000" style="width: 100%" onchange="loadSettings();"></td>
                                <td><input type="color" id="color-3" value="#aa00aa" style="width: 100%" onchange="loadSettings();"></td>
                                <td><input type="color" id="color-4" value="#00aa00" style="width: 100%" onchange="loadSettings();"></td>
                                <td><input type="color" id="color-5" value="#00aaaa" style="width: 100%" onchange="loadSettings();"></td>
                                <td><input type="color" id="color-6" value="#ffff55" style="width: 100%" onchange="loadSettings();"></td>
                            </tr>
                            <tr>
                                <td></td>
                                <th>1</th>
                                <th>2</th>
                                <th>3</th>
                                <th>4</th>
                                <th>5</th>
                                <th>6</th>
                            </tr>
                        </table>
                    </fieldset>
                    <fieldset>
                        <legend>Size</legend>
                            <input type="number" id="columns" value=40 min=20 max=400> columns by
                            <input type="number" id="rows" value=24 min=15 max=300> rows
                    </fieldset>
                    <fieldset>
                        <legend>Font</legend>
                        <select name="font" size="10" id="font">
                            <option value="smooth">Browser's native monospace</option>
                            <option value="tiny">A very small bitmap</option>
                            <option value="apple">Apple-II</option>
                            <option value="msx">MSX</option>
                            <option value="atari">Atari 8-bit</option>
                            <option value="bbc">Acorn BBC Micro</option>
                            <option value="c64">Commodore 64</option>
                            <option value="cpc">Amstrad/Schneider CPC</option>
                            <option value="exidy">Exidy Sorcerer</option>
                            <option value="genie1">EACA Colour Genie 1st</option>
                            <option value="genie2">EACA Colour Genie 2nd</option>
                            <option value="kc85">Robotron KC85/1</option>
                            <option value="pcw">Amstrad PCW/Schneider JOYCE</option>
                            <option value="spectrum">Sinclair ZX Spectrum</option>
                            <option value="vic">Commodore PET and VIC-20</option>
                            <option value="cga" selected>IBM CGA</option>
                            <option value="thin">IBM CGA thin stroke</option>
                            <option value="pcjr">IBM PCjr</option>
                            <option value="tandy">Tandy 1000</option>
                            <option value="tandy2">Tandy 1000 font, later version
                            <option value="p2000">Philips P2000T</option>
                            <option value="coco">Tandy TRS-80 CoCo v1&amp;2</option>
                            <option value="coco3">Tandy TRS-80 CoCo v3</option>
                            <option value="mpf">Multitech Micro-Professor MPF-I</option>
                            <option value="ega">IBM EGA</option>
                            <option value="mda">Hercules and IBM MDPA</option>
                            <option value="olivetti">Olivetti M24 and AT&amp;T 6300</option>
                            <option value="vga">IBM VGA</option>
                            <option value="wyse-serif">Wyse WY-700 serif</option>
                            <option value="wyse-sans">Wyse WY-700 sans serif</option>
                        </select>
                        <canvas id="showfont" style="height: 9em; margin: 0 1em 0 1em;">
                    </fieldset>
                    <fieldset>
                        <legend>Speed</legend>
                        <input type="range" id="speed" value=1000 min=1 max=100000>
                        <output id="showspeed">1000</output>
                        cycles per second
                    </fieldset>
                    <fieldset>
                        <legend>Presets</legend>
                        <button type="button" onclick="setSettings('cga');">CGA</button>
                        <button type="button" onclick="setSettings('c64');">Commodore 64</button>
                        <button type="button" onclick="setSettings('spectrum');">ZX Spectrum</button>
                        <button type="button" onclick="setSettings('msx');">MSX</button>
                        <button type="button" onclick="setSettings('cpc');">Amstrad CPC</button>
                        <button type="button" onclick="setSettings('pcw');">Amstrad PCW</button>
                        <button type="button" onclick="setSettings('bbc');">Acorn BBC Micro</button>
                        <button type="button" onclick="setSettings('coco');">TRS-80 Color Computer</button>
                    </fieldset>
                </form>
            </div>
        </div>

        <div id="diskette1">
            <a class="tab" href="#diskette1">Floppy</a>
            <div>
                <div id="flop1" class="floppy"></div>
            </div>
        </div>

        <div id="printer">
            <a class="tab" href="#printer">Printer</a>
            <div>
                <iframe id="printer0"></iframe>
            </div>
        </div>

        <div id="listing">
            <a class="tab" href="#listing">Listing</a>
            <div>
                <textarea id="listing0"></textarea>
            </div>
        </div>

        <div id="info">
            <a class="tab" href="#info">Info</a>
            <div>
                <pre id="info0"></pre>
            </div>
        </div>

        <div id="screen">
            <a class="tab" href="#screen">Screen</a>
            <div>
                <canvas class="basicode" id="canvas0"></canvas>
            </div>
        </div>

    </div>

    <small>
        BASICODE interpreter in Javascript. <noscript>Requires JavaScript.</noscript>
        <a href="https://github.com/robhagemans/basicode/">Use it with BASICODE programs such as these.</a>
        <a href="https://github.com/robhagemans/basicode-interpreter">Source is here.</a>
    </small>

</body>
</html>
